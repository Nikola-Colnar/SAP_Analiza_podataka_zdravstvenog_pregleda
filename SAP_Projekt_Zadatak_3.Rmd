---
title: "R Notebook"
output: pdf_document
---

Sljedeće što želimo provjeriti jest razlikuje li se prosječni krvni tlak značajno među skupinama s različitom učestalošću tjelesne aktivnosti. Naravno, prvo učitavamo podatke i potrebne biblioteke.


```{r}
library(dplyr)
library(ggplot2)
library(car)
library(nortest)

healthDATA.modif = read.csv("Health Screening Data.csv")

```



Nakon toga filtriramo podatke kako bismo izbacili nerealne vrijednosti te uvodimo šum, budući da su podaci uglavnom zaokruživani na 10 te ih je potrebno razložiti na ostale vrijednosti. Za šum koristimo uniformnu distribuciju ograničenu na ±5.


```{r}
# Postavljanje granica za krvni tlak
ap_hi_min <- 80
ap_hi_max <- 250
ap_lo_min <- 40
ap_lo_max <- 150

# Postavljanje realnih granica za BMI
bmi_min <- 10
bmi_max <- 60

set.seed(906)
healthDATA.modif <- healthDATA.modif %>%
  mutate(
    ap_hi = ap_hi + round(runif(n(), min = -5, max = 5)),
    ap_lo = ap_lo + round(runif(n(), min = -5, max = 5))
  )

# Čišćenje podataka
healthDATA.clean <- subset(healthDATA.modif, 
                           ap_hi > 87 & ap_hi < 167
                           & BMI > 14.45 & BMI < 39.65
                           & ap_lo > 59.5 & ap_lo < 103.5)


```

Za početak, kako bismo dobili dojam o utjecaju tjelesne aktivnosti, crtamo box plotove za sistolički i dijastolički krvni tlak grupirane prema tjelesnoj aktivnosti.

```{r}

# Pretpostavljamo da su podaci učitani u healthDATA.clean
# Podjela podataka prema aktivnosti
active_data <- healthDATA.clean %>% filter(active == 1)
inactive_data <- healthDATA.clean %>% filter(active == 0)

# 1) Boxplot za sistolički i dijastolički tlak prema aktivnosti
ggplot(healthDATA.clean, aes(x = factor(active, labels = c("Inactive", "Active")), y = ap_hi)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Distribucija sistoličkog tlaka prema aktivnosti", 
       x = "Aktivnost", 
       y = "Sistolički tlak")

ggplot(healthDATA.clean, aes(x = factor(active, labels = c("Inactive", "Active")), y = ap_lo)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Distribucija dijastoličkog tlaka prema aktivnosti", 
       x = "Aktivnost", 
       y = "Dijastolički tlak")


```

Iz plotova vidimo da su vrijednosti krvnih tlakova dosta slične kod aktivnih i neaktivnih ispitanika. Ipak, kako se ne bismo zadržali samo na tome, provjerit ćemo jednakost sredina odgovarajućim testovima.

Za određivanje možemo li koristiti t-test, provjeravamo njegove pretpostavke. Prvo ćemo ispitati normalnost grupa na temelju histograma i Q-Q plota.

```{r}

# 2) Histogram za sistolički i dijastolički tlak prema aktivnosti
ggplot(healthDATA.clean, aes(x = ap_hi, fill = factor(active, labels = c("Inactive", "Active")))) +
  geom_histogram(binwidth = 1, alpha = 0.6, position = "identity") +
  theme_minimal() +
  labs(title = "Histogram sistoličkog tlaka prema aktivnosti", 
       x = "Sistolički tlak", 
       fill = "Aktivnost")

ggplot(healthDATA.clean, aes(x = ap_lo, fill = factor(active, labels = c("Inactive", "Active")))) +
  geom_histogram(binwidth = 1, alpha = 0.6, position = "identity") +
  theme_minimal() +
  labs(title = "Histogram dijastoličkog tlaka prema aktivnosti", 
       x = "Dijastolički tlak", 
       fill = "Aktivnost")

# 5) Q-Q Plot za provjeru normalnosti
ggplot(healthDATA.clean, aes(sample = ap_hi)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ active, labeller = as_labeller(c("0" = "Inactive", "1" = "Active"))) +
  theme_minimal() +
  labs(title = "Q-Q plot za sistolički tlak prema aktivnosti")

ggplot(healthDATA.clean, aes(sample = ap_lo)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ active, labeller = as_labeller(c("0" = "Inactive", "1" = "Active"))) +
  theme_minimal() +
  labs(title = "Q-Q plot za dijastolički tlak prema aktivnosti")


```

Iz plotova vidimo da distribucija najvjerojatnije nije normalna, ali za svaki slučaj ćemo za provjeru normalnosti i jednakosti varijanci provesti Kolmogorov-Smirnovljev test i F-test.


```{r}
# 3) Kolmogorov-Smirnov test za normalnost
cat("\n===== Kolmogorov-Smirnov test za normalnost =====\n")

ks_hi_active <- ks.test(active_data$ap_hi, "pnorm", mean = mean(active_data$ap_hi), sd = sd(active_data$ap_hi))
ks_lo_active <- ks.test(active_data$ap_lo, "pnorm", mean = mean(active_data$ap_lo), sd = sd(active_data$ap_lo))

ks_hi_inactive <- ks.test(inactive_data$ap_hi, "pnorm", mean = mean(inactive_data$ap_hi), sd = sd(inactive_data$ap_hi))
ks_lo_inactive <- ks.test(inactive_data$ap_lo, "pnorm", mean = mean(inactive_data$ap_lo), sd = sd(inactive_data$ap_lo))

cat("\nKolmogorov-Smirnov test za ap_hi (Active): p-value:", ks_hi_active$p.value, "\n")
cat("Kolmogorov-Smirnov test za ap_lo (Active): p-value:", ks_lo_active$p.value, "\n")
cat("\nKolmogorov-Smirnov test za ap_hi (Inactive): p-value:", ks_hi_inactive$p.value, "\n")
cat("Kolmogorov-Smirnov test za ap_lo (Inactive): p-value:", ks_lo_inactive$p.value, "\n")

# 4) F-test za homogenost varijance
cat("\n===== F-test za varijance =====\n")

f_test_hi <- var.test(active_data$ap_hi, inactive_data$ap_hi)
f_test_lo <- var.test(active_data$ap_lo, inactive_data$ap_lo)

var.test(active_data$ap_hi, inactive_data$ap_hi)
var.test(active_data$ap_lo, inactive_data$ap_lo)

cat("\nF-test za ap_hi: p-value:", f_test_hi$p.value, "\n")
cat("F-test za ap_lo: p-value:", f_test_lo$p.value, "\n")

```

Iz rezultata vidimo da možemo odbaciti nultu hipotezu o normalnosti distribucija, dok iz F-testa vidimo da ne odbacujemo nultu hipotezu o jednakosti varijanci dviju distribucija. Unatoč nenormalnosti distribucija, provest ćemo t-test za usporedbu sredina budući da je robustan na nenormalnost uzorka. Ipak, provest ćemo i neparametarsku alternativu t-testu, Mann-Whitney-Wilcoxonov test.

```{r}

# Učitavanje potrebnih paketa
library(dplyr)

# Podjela podataka prema aktivnosti
active_data <- healthDATA.clean %>% filter(active == 1)
inactive_data <- healthDATA.clean %>% filter(active == 0)

# 1) Standardni t-test
cat("\n===== t-test za ap_hi =====\n")
t_test_hi <- t.test(active_data$ap_hi, inactive_data$ap_hi, var.equal = FALSE)
print(t_test_hi)

cat("\n===== t-test za ap_lo =====\n")
t_test_lo <- t.test(active_data$ap_lo, inactive_data$ap_lo, var.equal = FALSE)
print(t_test_lo)

# 2) Neparametrijski Mann-Whitney-Wilcoxon test
cat("\n===== Mann-Whitney-Wilcoxon test za ap_hi =====\n")
wilcox_hi <- wilcox.test(active_data$ap_hi, inactive_data$ap_hi)
print(wilcox_hi)

cat("\n===== Mann-Whitney-Wilcoxon test za ap_lo =====\n")
wilcox_lo <- wilcox.test(active_data$ap_lo, inactive_data$ap_lo)
print(wilcox_lo)


```
Nakon provedbe testova vidimo da ne možemo odbaciti nultu hipotezu prema kojoj su srednje vrijednosti tlakova aktivne i neaktivne grupe jednake. Stoga, ne možemo tvrditi da se prosječni krvni tlak značajno razlikuje među skupinama s različitom učestalošću tjelesne aktivnosti.

Ipak, zanima nas i razlikuje li se značajno prosječni krvni tlak među skupinama s različitim BMI kategorijama. Za početak, kako bismo dobili dojam, crtamo box plotove koji nam daju početni uvid u podatke.


```{r}


# Boxplot za sistolički tlak (ap_hi) po BMI kategorijama
p_hi <- ggplot(healthDATA.clean, aes(x = BMICat, y = ap_hi)) + 
  geom_boxplot(fill = "skyblue", alpha = 0.7, outlier.color = "red") +
  # Crvena isprekidana linija je ukupna sredina (mean) ap_hi
  geom_hline(yintercept = mean(healthDATA.clean$ap_hi), 
             color = "red", linetype = "dashed", size = 1) +
  labs(title = "Box plot sistoličkog tlaka po BMI kategorijama", 
       x = "BMI kategorija", 
       y = "Sistolički tlak") +
  theme_minimal()

# Boxplot za dijastolički tlak (ap_lo) po BMI kategorijama
p_lo <- ggplot(healthDATA.clean, aes(x = BMICat, y = ap_lo)) + 
  geom_boxplot(fill = "orange", alpha = 0.7, outlier.color = "blue") +
  # Crvena isprekidana linija je ukupna sredina (mean) ap_lo
  geom_hline(yintercept = mean(healthDATA.clean$ap_lo), 
             color = "red", linetype = "dashed", size = 1) +
  labs(title = "Box plot dijastoličkog tlaka po BMI kategorijama", 
       x = "BMI kategorija", 
       y = "Dijastolički tlak") +
  theme_minimal()

# Prikaz oba grafa
print(p_hi)
print(p_lo)



```
Prema box plotovima vidimo da je za očekivati kako se prosječni tlakovi značajno razlikuju među različitim skupinama, ali to moramo potvrditi odgovarajućim statističkim testovima. U ovom slučaju testiramo jednakost sredina četiri različite skupine, za što je potrebno koristiti ANOVA-u. Ipak, prije toga moramo provjeriti pretpostavke ANOVE. Prvo ćemo nacrtati histograme i Q-Q plotove kako bismo stekli dojam o normalnosti skupina. 

```{r}
# Lista jedinstvenih BMI kategorija
bmi_categories <- unique(healthDATA.clean$BMICat)

# Kreiranje histograma i QQ plotova za svaku BMI kategoriju
for (bmi_cat in bmi_categories) {
  
  # Filtriranje podataka za trenutnu BMI kategoriju
  data_subset <- healthDATA.clean %>% filter(BMICat == bmi_cat)
  
  # Histogram za sistolički tlak
  p1 <- ggplot(data_subset, aes(x = ap_hi)) +
    geom_histogram(binwidth = 2, fill = "blue", color = "black", alpha = 0.7) +
    labs(title = paste("Distribucija sistoličkog tlaka -", bmi_cat),
         x = "Sistolički tlak", y = "Frekvencija") +
    theme_minimal()
  
  # Histogram za dijastolički tlak
  p2 <- ggplot(data_subset, aes(x = ap_lo)) +
    geom_histogram(binwidth = 2, fill = "red", color = "black", alpha = 0.7) +
    labs(title = paste("Distribucija dijastoličkog tlaka -", bmi_cat),
         x = "Dijastolički tlak", y = "Frekvencija") +
    theme_minimal()
  
  # QQ plot za sistolički tlak
  p3 <- ggplot(data_subset, aes(sample = ap_hi)) +
    stat_qq(color = "blue") +
    stat_qq_line(color = "red") +
    labs(
      title = paste("Q-Q plot - Sistolički tlak -", bmi_cat),
      x = "Teorijske kvantile",
      y = "Empirijske kvantile"
    ) +
    theme_minimal()
  
  # QQ plot za dijastolički tlak
  p4 <- ggplot(data_subset, aes(sample = ap_lo)) +
    stat_qq(color = "blue") +
    stat_qq_line(color = "red") +
    labs(
      title = paste("Q-Q plot - Dijastolički tlak -", bmi_cat),
      x = "Teorijske kvantile",
      y = "Empirijske kvantile"
    ) +
    theme_minimal()
  
  # Prikaz grafova
  print(p1)
  print(p2)
  print(p3)
  print(p4)
}

```
Nakon crtanja histograma i Q-Q plotova dobivamo dojam da skupine ne ispunjavaju uvjet normalnosti, ali svejedno ćemo provesti Kolmogorov-Smirnovljev test kako bismo tu tvrdnju dodatno provjerili. Također, provest ćemo i Bartlettov test za provjeru homoskedastičnosti, koja je još bitnija pretpostavka ANOVE.

```{r}
# Potrebne biblioteke
library(dplyr)
library(car)  # za Leveneov test

# 1) Test normalnosti po grupama (Kolmogorov-Smirnov)
bmi_categories <- unique(healthDATA.clean$BMICat)

for (bmi_cat in bmi_categories) {
  
  data_subset <- healthDATA.clean %>%
    filter(BMICat == bmi_cat)
  
  cat("==================================================\n")
  cat("BMI Category:", bmi_cat, "\n")
  cat("Broj zapisa u ovoj kategoriji:", nrow(data_subset), "\n")
  
  # Kolmogorov–Smirnov test za ap_hi
  ks_hi <- ks.test(
    data_subset$ap_hi, 
    "pnorm",
    mean = mean(data_subset$ap_hi), 
    sd   = sd(data_subset$ap_hi)
  )
  cat("\n>> Kolmogorov-Smirnov test - ap_hi <<\n")
  cat("  p-value:", ks_hi$p.value, "\n")
  
  # Kolmogorov–Smirnov test za ap_lo
  ks_lo <- ks.test(
    data_subset$ap_lo, 
    "pnorm",
    mean = mean(data_subset$ap_lo), 
    sd   = sd(data_subset$ap_lo)
  )
  cat("\n>> Kolmogorov-Smirnov test - ap_lo <<\n")
  cat("  p-value:", ks_lo$p.value, "\n\n")
}

cat("==================================================\n")
cat("     Test homoskedastičnosti (BartlettTest)\n")
cat("==================================================\n")

# Bartlettov test za sistolički tlak
bartlett_hi <- bartlett.test(ap_hi ~ BMICat, data = healthDATA.clean)
cat("\nBartlett test: ap_hi ~ BMICat\n")
print(bartlett_hi)

# Bartlettov test za dijastolički tlak
bartlett_lo <- bartlett.test(ap_lo ~ BMICat, data = healthDATA.clean)
cat("\nBartlett test: ap_lo ~ BMICat\n")
print(bartlett_lo)


```

Iščitavanjem p-vrijednosti iz testova možemo odbaciti pretpostavke o normalnosti i homoskedastičnosti skupina. Stoga moramo odustati od provedbe ANOVE te se okrećemo njezinoj neparametarskoj alternativi, Kruskal-Wallisovu testu.

```{r}
# Kruskal-Wallis za sistolički tlak
kruskal_hi <- kruskal.test(ap_hi ~ BMICat, data = healthDATA.clean)
cat("----- Kruskal-Wallis Test za sistolički tlak -----\n")
print(kruskal_hi)

# Kruskal-Wallis za dijastolički tlak
kruskal_lo <- kruskal.test(ap_lo ~ BMICat, data = healthDATA.clean)
cat("\n----- Kruskal-Wallis Test za dijastolički tlak -----\n")
print(kruskal_lo)


```
Nakon provedbe Kruskal-Wallisova testa vidimo da niske p-vrijednosti sugeriraju odbacivanje početne hipoteze o jednakosti sredina te prihvaćamo alternativu da se stvarne sredine razlikuju među različitim BMI skupinama.





