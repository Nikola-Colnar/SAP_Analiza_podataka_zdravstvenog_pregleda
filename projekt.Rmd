---
title: "[SAP] Projektni zadatak - Analiza podataka zdravstvenog pregleda"
author: "Statistički najizglednije ime"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(results = 'hold')
library(tidyverse)
library(lubridate)
library(nortest)
library(car)
library(patchwork)
```

#Inicijalni koraci projekta
## Učitavanje podataka

```{r, include=FALSE}
# Učitavanje podataka iz csv datoteke:
healthDATA.modif = read.csv("Health Screening Data.csv")
#View(healthDATA.modif)
total = 0
weird = 0
for (p in healthDATA.modif$ap_hi) {
  if (p < 50) {
    weird = weird + 1
  }
  total = total + 1
}
weird / total
```
##Filtriranje podataka

Početna faza analize uključila je čišćenje podataka korištenjem više kriterija. Eliminirane su sve observacije s nelogičnim vrijednostima tlaka (npr. negativne vrijednosti) te slučajevi gdje maksimalni tlak prelazi minimalni. Dodatno, izbačeni su ekstremni BMI-ovi te restrigirani na raspone unutar NHS inform podataka. (Izvor: https://www.nhsinform.scot/healthy-living/food-and-nutrition/healthy-eating-and-weight-management/body-mass-index-bmi/)

```{r}
# Filtriranje besmislenih podataka iz tablice
filtered_data <- healthDATA.modif %>% filter(ap_hi <= 370) %>% 
  filter(ap_lo <= 360) %>% filter(ap_hi >= 40) %>% filter(ap_lo >= 0) %>% 
  filter(ap_hi >= ap_lo) %>% filter(BMI <= 52.3) 

filtered_data <- filtered_data %>%
  mutate(
    cholesterol = as.factor(cholesterol),
    gender = as.factor(gender),
    AgeGroup = as.factor(AgeGroup)
  ) %>% mutate (AgeGroup = fct_relevel(AgeGroup, "20-40", "40-60", ">60"))

#summary(filtered_data)
#head(filtered_data)
```

```{r}
#Analiza skupa podataka
filtered_data <- filtered_data %>%
  mutate(gender = factor(gender, 
                         levels = c(1, 2), 
                         labels = c("Female", "Male")))

average_weight <- filtered_data %>%
  group_by(gender) %>%
  summarise(avg_weight = mean(weight, na.rm = TRUE))

average_weight

average_height <- filtered_data %>%
  group_by(gender) %>%
  summarise(avg_height = mean(height, na.rm = TRUE))

average_height

#str(filtered_data)
#head(filtered_data)
```

#Zadatak 1: 
##Kakva je distribucija razina kolesterola među različitim dobnim skupinama i spolovima?

```{r}
# Zadatak 1

distribution <- filtered_data %>%
  group_by(AgeGroup, gender, cholesterol) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(AgeGroup, gender) %>%
  mutate(percentage = count / sum(count) * 100)

#distribution

ggplot(distribution, aes(x = cholesterol, y = percentage, fill = gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ AgeGroup) +
  labs(title = "Distribucija kolesterola prema spolu i dobnoj skupini",
       x = "Kategorije kolesterola",
       y = "Postotak unutar spola (%)") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink"))

```

Grafički prikazi ilustriraju postotnu zastupljenost tri kategorije kolesterola (1-zdrav, 2-rizičan, 3-opasan) kroz dobne skupine i spolove. Vizualno odvajanje kategorija ostvareno je paletom boja: zelenom za zdravu, žutom za rizičnu i ljubičastom za opasnu razinu.

    Zdrav (1) – prikazan zelenkastom bojom,
    Rizičan (2) – prikazan žutom bojom,
    Opasan (3) – prikazan ljubičastom bojom.

Prvi graf prikazuje raspodjelu unutar tri dobne skupine: 20-40 godina, 40-60 godina i iznad 60 godina.

```{r}
cholesterol_age <- filtered_data %>%
  group_by(AgeGroup, cholesterol) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(AgeGroup) %>%
  mutate(percentage = count / sum(count) * 100)

ggplot(cholesterol_age, aes(x = cholesterol, y = percentage, fill = cholesterol)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ AgeGroup) +
  labs(title = "Postotak kolesterola unutar dobnih skupina",
       x = "Kategorija kolesterola",
       y = "Postotak") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")
```
Zaključci sa grafa:
  - U svakoj dobnoj skupini prevladava zdrava kategorija kolesterola.
  - Dobna skupina 20-40 godina ima najzdravije razine kolesterola, s najmanjom zastupljenošću rizične i opasne kategorije.
  - Skupina iznad 60 godina i dalje najčešće pripada zdravoj kategoriji, ali ima veću zastupljenost rizičnih i opasnih kategorija. Također, u ovoj skupini opasna kategorija nadmašuje rizičnu.
  
Sljedeći graf prikazuje distribuciju kolesterola prema spolovima.
```{r}
cholesterol_gender <- filtered_data %>%
  group_by(gender, cholesterol) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(gender) %>%
  mutate(percentage = count / sum(count) * 100)

ggplot(cholesterol_gender, aes(x = cholesterol, y = percentage, fill = cholesterol)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ gender) +
  labs(title = "Postotak kolesterola unutar spolova",
       x = "Kategorija kolesterola",
       y = "Postotak") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")
```
Zaključci sa grafa:
  - Zdrava kategorija dominira u svakom spolu.
  - Razlike između spolova u distribuciji kategorija kolesterola nisu značajne.

##Prikaz dodatnih distribucija

Također nas zanima kako su u uzorku distribuirani indeks tjelesne mase te krvni tlak.
Fokusirani grafovi prikazuju češće vrijednosti kako bi se istaknula opća tendencija.

Distribucija indeksa tjelesne mase analizirana je prema dobnim skupinama i spolovima.

```{r}

BMI_filtered_data <- filtered_data %>% filter(BMI <= 60)

ggplot(BMI_filtered_data, aes(x = BMI, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Istaknuta Distribucija BMI-ja prema dobnoj skupini",
       x = "BMI",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")
```

```{r}
ggplot(BMI_filtered_data, aes(x = BMI, color = gender, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(title = "Istaknuta distribucija BMI-ja prema spolu",
       x = "BMI",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink")) +
  scale_color_manual(values = c("blue", "pink"))
```
Zaključak
  - BMI većinom pripada rasponu između 20 i 30, dok su vrijednosti iznad 30 rjeđe i opadaju prema 40.

Distribucija sistoličkog i dijastoličkog krvnog tlaka također je analizirana prema dobnim skupinama i spolovima.

```{r}
ap_filtered_data <- filtered_data %>% filter(ap_hi <= 190) %>% filter(ap_lo <= 130) %>% filter(ap_hi >= 80) %>% filter(ap_lo >= 50)

ap_hi_distribution_g1 <- ggplot(ap_filtered_data, aes(x = ap_hi, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Istaknuta distribucija\nsistoličkog krvnog\ntlaka prema dobnoj skupini",
       x = "Sistolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")

ap_lo_distribution_g1 <-  ggplot(ap_filtered_data, aes(x = ap_lo, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Istaknuta distribucija\ndijastoličkog krvnog tlaka\nprema dobnoj skupini",
       x = "Dijastolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")

ap_hi_distribution_g1 + ap_lo_distribution_g1
```

Prema spolu:
```{r}
ap_hi_distribution_g2 <- ggplot(ap_filtered_data, aes(x = ap_hi, color = gender, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(title = "Istaknuta distribucija\nsistoličkog krvnog tlaka prema spolu",
       x = "Sistolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink")) +
  scale_color_manual(values = c("blue", "pink"))

ap_lo_distribution_g2 <- ggplot(ap_filtered_data, aes(x = ap_lo, color = gender, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(title = "Istaknuta distribucija\ndijastoličkog krvnog tlaka prema spolu",
       x = "Dijastolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink")) +
  scale_color_manual(values = c("blue", "pink"))

ap_hi_distribution_g2 + ap_lo_distribution_g2
```

Zaključak
  - Krvni tlak pokazuje višemodalnu distribuciju, pri čemu je najčešća vrijednost 120/80 mmHg.

Analizom distribucije krvnog tlaka primijetili smo da se podaci raspodjeljuju višemodalno, što intuitivno nije logično. Na primjer, zašto bi tlak od 80 bio učestaliji od tlaka 85, dok je tlak od 90 također učestaliji od 85? Objašnjenje leži u tendenciji liječnika da zaokružuju vrijednosti krvnog tlaka na brojeve koji završavaju nulom.

Kako je navedeno u dokumentu Svjetske zdravstvene organizacije (WHO) iz travnja 2020., "tehničke pogreške uzrokovane opažačem uključuju sustavne pogreške povezane s ... i suboptimalno bilježenje izmjerenih vrijednosti krvnog tlaka. Primjer je 'preferencija završnog broja', pri čemu opažač zaokružuje izmjerene vrijednosti na preferirani broj, obično nulu." (Izvor: WHO technical specifications for automated non-invasive blood pressure measuring devices with cuff)

Smatramo da ovaj fenomen značajno utječe na statističke analize. Kako bismo bolje reprezentirali podatke i smanjili utjecaj ove pristranosti, u analizu smo uključili dodavanje uniformnog šuma.
 
```{r}
set.seed(906) 

original_filtered_data <- filtered_data

filtered_data <- filtered_data %>%
  mutate(
    ap_hi = ap_hi + runif(n(), min = -5 , max = 5),
    ap_lo = ap_lo + runif(n(), min = -5 , max = 5)
  )

ap_filtered_data <- filtered_data %>% filter(ap_hi <= 190) %>% filter(ap_lo <= 130) %>% filter(ap_hi >= 80) %>% filter(ap_lo >= 50)

ap_hi_distribution_g3 <- ggplot(ap_filtered_data, aes(x = ap_hi, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija sistoličkog\nkrvnog tlaka sa dodanim šumom\nprema dobnoj skupini",
       x = "Sistolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")

ap_lo_distribution_g3 <- ggplot(ap_filtered_data, aes(x = ap_lo, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija dijastoličkog\nkrvnog tlaka sa dodanim šumom\nprema dobnoj skupini",
       x = "Dijastolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")

ap_hi_distribution_g3 + ap_lo_distribution_g3
```

#Zadatak 2
##Postoji li značajna razlika u prosječnom krvnom tlaku izmedu pušača i nepušača?

Testiramo postoji li statistički značajna razlika u prosječnim krvnim tlakovima kod pušača i kod nepušača. Pušenje je kategorijska varijabla (razlikujemo pušače i nepušače, a nema podataka o tome koliko često tko puši).

Tlakove pušača i nepušača možemo prvo usporediti grafički pomoću box plotova. U uzorku preostaje oko 6100 pušača i 63000 nepušača nakon eliminacije besmislenih vrijednosti, što znači da imamo dovoljno podataka da kasnije u testiranju možemo koristiti centralni granični teorem. Vidimo da plotovi izgledaju dosta slično. I dalje postoji dosta outliera, pogotovo s visokim tlakom, ali nema ih smisla odbaciti kao pogrešna mjerenja jer je najveći tlak 240, što je sasvim moguća vrijednost.

```{r}
pusaci = filtered_data[filtered_data["smoke"]==1,]
nepusaci = filtered_data[filtered_data["smoke"]==0,]
nrow(pusaci)
nrow(nepusaci)

boxplot(nepusaci$ap_hi,
        main='box-plot tlaka nepušača',
        ylab='sistolički tlak/mmHg')
boxplot(pusaci$ap_hi,
        main='box-plot tlaka pušača',
        ylab='sistolički tlak/mmHg')

```

Najprije provjeravama jesu li podaci iz normalne razdiobe. Kako ne znamo koju konkretnu normalnu razdiobu očekujemo, koristimo Lillieforsovu inačicu Kolmogorov-Smirnovljevog testa. Posebno testiramo tlakove pušača i tlakove nepušača. Također radimo Q-Q plotove za vizualnu usporedbu kvantila s kvantilima normalne razdiobe.

```{r}
pusaci = filtered_data[filtered_data["smoke"]==1,]
nepusaci = filtered_data[filtered_data["smoke"]==0,]

lillie.test(pusaci$ap_hi)
lillie.test(nepusaci$ap_hi)
qqnorm(pusaci$ap_hi, main = "Q-Q plot za tlakove pušača")
qqline(pusaci$ap_hi, col="blue")

qqnorm(nepusaci$ap_hi, main = "Q-Q plot za tlakove nepušača")
qqline(nepusaci$ap_hi, col="red")
```

Test odbacuje nul-hipotezu (da su podaci slučajan uzorak iz normalne razdiobe) za obje grupe na razini značajnosti od 1%. Na Q-Q plotovima vidimo da distribucija podataka relativno dobro prati normalnu za vrijednosti oko prosjeka i manje, ali ima vrlo teški rep prema većim vrijednostima. To je u skladu s prisutnošću mnogo outliera vidljivih u tom području na box plotu.

Treba provjeriti jesu li varijance grupa jednake. Provodimo F-test za jednakost varijanci sitoličkih tlakova nepušača i pušača. Dobivamo vrlo malu p-vrijednost, pa odbacujemo nul-hipotezu. Procijenjeni omjer varijanci je oko 0.9, dakle pušači imaju veću varijancu u sistoličkom tlaku nego nepušači. Poznato je da pušenje uzrokuje kratkotrajni porast krvnog tlaka. Moguće je tlakovi pušača više variraju jer su nekim pušačima tlakovi izmjereni ubrzo nakon pušenja, a nekima nakon nekoliko sati bez cigareta. U svakom slučaju, ne možemo pretpostaviti jednakost varijanci u daljnjim testovima.

```{r}
var.test(nepusaci$ap_hi, pusaci$ap_hi)
```

Testiramo hipotezu o jednakosti prosječnih krvnih tlakova u obje grupe koristeći T test za neuparene podatke uz nepoznate i nejednake varijance na razini značajnosti od 5%. Ne uzimamo pretpostavku da su varijance jednake zbog rezultata prethodnog testa. 

```{r}
t.test(filtered_data[filtered_data["smoke"]==0,]$ap_hi, filtered_data[filtered_data["smoke"]==1,]$ap_hi, alternative = "two.sided", mu = 0, paired = FALSE, var.equal = FALSE, conf.level = 0.95)
```
Dobivena P vrijednost je vrlo mala pa možemo odbaciti hipotezu o jednakosti srednjih vrijednosti sistoličkih tlakova na razini značajnosti od 5%. Test pokazuje statistički značajnu razliku, no procijenjena razlika sredina je mala u odnosu na 30 mmHg koliko otprilike iznosi širina intervala normalnih tlakova pa je značaj te razlike u praksi upitan.


#Zadatak 3
##Razlikuje li se prosječni krvni tlak značajno medu skupinama s različitom učestalošću tjelesne aktivnosti?

Za početak, kako bismo dobili dojam o utjecaju tjelesne aktivnosti, crtamo box plotove za sistolički i dijastolički krvni tlak grupirane prema tjelesnoj aktivnosti.

```{r}

# Kreiranje boxplota za ap_hi
p1 <- ggplot(healthDATA.clean, aes(x = factor(active, labels = c("Inactive", "Active")), y = ap_hi)) +
  geom_boxplot(fill = "lightblue") +
  theme_minimal(base_size = 12) +
  labs(title = "Sistolički tlak prema aktivnosti \n",
       x = "Aktivnost", 
       y = "Sistolički tlak") +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 10)
  )

# Kreiranje boxplota za ap_lo
p2 <- ggplot(healthDATA.clean, aes(x = factor(active, labels = c("Inactive", "Active")), y = ap_lo)) +
  geom_boxplot(fill = "lightgreen") +
  theme_minimal(base_size = 12) +
  labs(title = "Dijastolički tlak prema aktivnosti \n",
       x = "Aktivnost", 
       y = "Dijastolički tlak") +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 10)
  )

# Grupiranje boxplota horizontalno sa razmakom i višerednim naslovom
combined_boxplots <- p1 + p2 + 
  plot_layout(ncol = 2, widths = c(1, 1), guides = "collect") + 
  plot_annotation(title = "Boxplotovi krvnog tlaka \nprema aktivnosti") &
  theme(plot.title = element_text(size = 14, hjust = 0.5))

# Prikaz kombiniranih boxplotova
print(combined_boxplots)




```

Iz plotova vidimo da su vrijednosti krvnih tlakova dosta slične kod aktivnih i neaktivnih ispitanika. Ipak, kako se ne bismo zadržali samo na tome, provjerit ćemo jednakost sredina odgovarajućim testovima.

Za određivanje možemo li koristiti t-test, provjeravamo njegove pretpostavke. Prvo ćemo ispitati normalnost grupa na temelju histograma i Q-Q plota.

```{r}
# Kreiranje histogramova za ap_hi
hist_hi <- ggplot(healthDATA.clean, aes(x = ap_hi, fill = factor(active, labels = c("Inactive", "Active")))) +
  geom_histogram(binwidth = 2, alpha = 0.6, position = "identity", color = "black") +
  theme_minimal(base_size = 10) +
  labs(title = "Histogram sistoličkog tlaka \nprema aktivnosti", 
       x = "Sistolički tlak", 
       fill = "Aktivnost") +
  theme(
    plot.title = element_text(size = 10, hjust = 0.5),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 10),
    legend.position = "bottom"
  )

# Kreiranje histogramova za ap_lo
hist_lo <- ggplot(healthDATA.clean, aes(x = ap_lo, fill = factor(active, labels = c("Inactive", "Active")))) +
  geom_histogram(binwidth = 2, alpha = 0.6, position = "identity", color = "black") +
  theme_minimal(base_size = 10) +
  labs(title = "Histogram dijastoličkog tlaka \nprema aktivnosti", 
       x = "Dijastolički tlak", 
       fill = "Aktivnost") +
  theme(
    plot.title = element_text(size = 10, hjust = 0.5),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 10),
    legend.position = "bottom"
  )

# Kreiranje Q-Q plotova za ap_hi
qq_hi <- ggplot(healthDATA.clean, aes(sample = ap_hi)) +
  stat_qq(color = "darkblue") +
  stat_qq_line(color = "red") +
  facet_wrap(~ active, labeller = as_labeller(c("0" = "Inactive", "1" = "Active"))) +
  theme_minimal(base_size = 10) +
  labs(title = "Q-Q plot sistoličkog tlaka \nprema aktivnosti",
       x = "Teorijske kvantile",
       y = "Empirijske kvantile") +
  theme(
    plot.title = element_text(size = 10, hjust = 0.5),
    strip.text = element_text(size = 10),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 10)
  )

# Kreiranje Q-Q plotova za ap_lo
qq_lo <- ggplot(healthDATA.clean, aes(sample = ap_lo)) +
  stat_qq(color = "darkgreen") +
  stat_qq_line(color = "red") +
  facet_wrap(~ active, labeller = as_labeller(c("0" = "Inactive", "1" = "Active"))) +
  theme_minimal(base_size = 10) +
  labs(title = "Q-Q plot dijastoličkog tlaka \nprema aktivnosti",
       x = "Teorijske kvantile",
       y = "Empirijske kvantile") +
  theme(
    plot.title = element_text(size = 12, hjust = 0.5),
    strip.text = element_text(size = 10),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 10)
  )

# Grupiranje histogramova u jedan red sa višerednim naslovom
combined_histograms <- hist_hi + hist_lo + 
  plot_layout(ncol = 2, widths = c(1, 1)) + 
  plot_annotation(title = "Histograme krvnog tlaka \nprema aktivnosti") &
  theme(plot.title = element_text(size = 12, hjust = 0.5))

# Grupiranje Q-Q plotova u jedan red sa višerednim naslovom
combined_qqplots <- qq_hi + qq_lo + 
  plot_layout(ncol = 2, widths = c(1, 1)) + 
  plot_annotation(title = "Q-Q Plotovi krvnog tlaka \nprema aktivnosti") &
  theme(plot.title = element_text(size = 12, hjust = 0.5))

# Grupiranje svih histogramova i Q-Q plotova u jedan layout
final_combined <- (combined_histograms / combined_qqplots) + 
  plot_layout(ncol = 1, heights = c(1, 1)) &
  theme(
    plot.title = element_text(size = 12, hjust = 0.5),
    plot.margin = margin(10,10,10,10)
  )

# Prikaz kombiniranih grafova
print(final_combined)



```

Iz plotova vidimo da distribucija najvjerojatnije nije normalna, ali za svaki slučaj ćemo za provjeru normalnosti i jednakosti varijanci provesti Kolmogorov-Smirnovljev test i F-test.


```{r}
# 3) Kolmogorov-Smirnov test za normalnost
cat("\n===== Kolmogorov-Smirnov test za normalnost =====\n")

ks_hi_active <- ks.test(active_data$ap_hi, "pnorm", mean = mean(active_data$ap_hi), sd = sd(active_data$ap_hi))
ks_lo_active <- ks.test(active_data$ap_lo, "pnorm", mean = mean(active_data$ap_lo), sd = sd(active_data$ap_lo))

ks_hi_inactive <- ks.test(inactive_data$ap_hi, "pnorm", mean = mean(inactive_data$ap_hi), sd = sd(inactive_data$ap_hi))
ks_lo_inactive <- ks.test(inactive_data$ap_lo, "pnorm", mean = mean(inactive_data$ap_lo), sd = sd(inactive_data$ap_lo))

cat("\nKolmogorov-Smirnov test za ap_hi (Active): p-value:", ks_hi_active$p.value, "\n")
cat("Kolmogorov-Smirnov test za ap_lo (Active): p-value:", ks_lo_active$p.value, "\n")
cat("\nKolmogorov-Smirnov test za ap_hi (Inactive): p-value:", ks_hi_inactive$p.value, "\n")
cat("Kolmogorov-Smirnov test za ap_lo (Inactive): p-value:", ks_lo_inactive$p.value, "\n")

# 4) F-test za homogenost varijance
cat("\n===== F-test za varijance =====\n")

f_test_hi <- var.test(active_data$ap_hi, inactive_data$ap_hi)
f_test_lo <- var.test(active_data$ap_lo, inactive_data$ap_lo)

var.test(active_data$ap_hi, inactive_data$ap_hi)
var.test(active_data$ap_lo, inactive_data$ap_lo)

cat("\nF-test za ap_hi: p-value:", f_test_hi$p.value, "\n")
cat("F-test za ap_lo: p-value:", f_test_lo$p.value, "\n")

```

Iz rezultata vidimo da možemo odbaciti nultu hipotezu o normalnosti distribucija, dok iz F-testa vidimo da ne odbacujemo nultu hipotezu o jednakosti varijanci dviju distribucija. Unatoč nenormalnosti distribucija, provest ćemo t-test za usporedbu sredina budući da je robustan na nenormalnost uzorka. Ipak, provest ćemo i neparametarsku alternativu t-testu, Mann-Whitney-Wilcoxonov test.

```{r}

# Učitavanje potrebnih paketa
library(dplyr)

# Podjela podataka prema aktivnosti
active_data <- healthDATA.clean %>% filter(active == 1)
inactive_data <- healthDATA.clean %>% filter(active == 0)

# 1) Standardni t-test
cat("\n===== t-test za ap_hi =====\n")
t_test_hi <- t.test(active_data$ap_hi, inactive_data$ap_hi, var.equal = FALSE)
print(t_test_hi)

cat("\n===== t-test za ap_lo =====\n")
t_test_lo <- t.test(active_data$ap_lo, inactive_data$ap_lo, var.equal = FALSE)
print(t_test_lo)

# 2) Neparametrijski Mann-Whitney-Wilcoxon test
cat("\n===== Mann-Whitney-Wilcoxon test za ap_hi =====\n")
wilcox_hi <- wilcox.test(active_data$ap_hi, inactive_data$ap_hi)
print(wilcox_hi)

cat("\n===== Mann-Whitney-Wilcoxon test za ap_lo =====\n")
wilcox_lo <- wilcox.test(active_data$ap_lo, inactive_data$ap_lo)
print(wilcox_lo)


```
Nakon provedbe testova vidimo da ne možemo odbaciti nultu hipotezu prema kojoj su srednje vrijednosti tlakova aktivne i neaktivne grupe jednake. Stoga, ne možemo tvrditi da se prosječni krvni tlak značajno razlikuje među skupinama s različitom učestalošću tjelesne aktivnosti.

Ipak, zanima nas i razlikuje li se značajno prosječni krvni tlak među skupinama s različitim BMI kategorijama. Za početak, kako bismo dobili dojam, crtamo box plotove koji nam daju početni uvid u podatke.


```{r}

# Kreiranje boxplota za ap_hi po BMICat
p_hi <- ggplot(healthDATA.clean, aes(x = BMICat, y = ap_hi)) + 
  geom_boxplot(fill = "skyblue", alpha = 0.7, outlier.color = "red") +
  geom_hline(yintercept = mean(healthDATA.clean$ap_hi), 
             color = "red", linetype = "dashed", size = 1) +
  labs(title = "Sistolički tlak po BMI kategorijama \n",
       x = "BMI kategorija", 
       y = "Sistolički tlak") +
  scale_x_discrete(labels = c("Normal"       = "Normal",
                              "Obese"        = "Obese",
                              "Over Weight"  = "Over\nWeight",
                              "Under Weight" = "Under\nWeight")) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )

# Kreiranje boxplota za ap_lo po BMICat
p_lo <- ggplot(healthDATA.clean, aes(x = BMICat, y = ap_lo)) + 
  geom_boxplot(fill = "orange", alpha = 0.7, outlier.color = "blue") +
  geom_hline(yintercept = mean(healthDATA.clean$ap_lo), 
             color = "red", linetype = "dashed", size = 1) +
  labs(title = "Dijastolički tlak po BMI kategorijama \n",
       x = "BMI kategorija", 
       y = "Dijastolički tlak") +
  scale_x_discrete(labels = c("Normal"       = "Normal",
                              "Obese"        = "Obese",
                              "Over Weight"  = "Over\nWeight",
                              "Under Weight" = "Under\nWeight")) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )

combined_boxplots_bmi <- p_hi + p_lo + 
  plot_layout(ncol = 2, widths = c(1, 1), guides = "collect") + 
  plot_annotation(title = "Boxplotovi krvnog tlaka po BMI kategorijama \n") &
  theme(plot.title = element_text(size = 14, hjust = 0.5))

print(combined_boxplots_bmi)


```
Prema box plotovima vidimo da je za očekivati kako se prosječni tlakovi značajno razlikuju među različitim skupinama, ali to moramo potvrditi odgovarajućim statističkim testovima. U ovom slučaju testiramo jednakost sredina četiri različite skupine, za što je potrebno koristiti ANOVA-u. Ipak, prije toga moramo provjeriti pretpostavke ANOVE. Prvo ćemo nacrtati histograme i Q-Q plotove kako bismo stekli dojam o normalnosti skupina. 

```{r}
for (bmi_cat in bmi_categories) {
  
  data_subset <- healthDATA.clean %>% filter(BMICat == bmi_cat)
  
  hist_hi <- ggplot(data_subset, aes(x = ap_hi)) +
    geom_histogram(binwidth = 2, fill = "blue", color = "black", alpha = 0.7) +
    labs(title = "Distribucija sistoličkog tlaka",
         x = "Sistolički tlak", y = "Frekvencija") +
    theme_minimal(base_size = 12)

  hist_lo <- ggplot(data_subset, aes(x = ap_lo)) +
    geom_histogram(binwidth = 2, fill = "red", color = "black", alpha = 0.7) +
    labs(title = "Distribucija dijastoličkog tlaka",
         x = "Dijastolički tlak", y = "Frekvencija") +
    theme_minimal(base_size = 12)

  qq_hi <- ggplot(data_subset, aes(sample = ap_hi)) +
    stat_qq(color = "darkblue") +
    stat_qq_line(color = "red") +
    labs(title = "Q-Q plot - Sistolički tlak",
         x = "Teorijske kvantile",
         y = "Empirijske kvantile") +
    theme_minimal(base_size = 12)
  
  qq_lo <- ggplot(data_subset, aes(sample = ap_lo)) +
    stat_qq(color = "darkgreen") +
    stat_qq_line(color = "red") +
    labs(title = "Q-Q plot - Dijastolički tlak",
         x = "Teorijske kvantile",
         y = "Empirijske kvantile") +
    theme_minimal(base_size = 12)

  hist_combined <- hist_hi + hist_lo + 
    plot_layout(ncol = 2) + 
    plot_annotation(title = paste("Histograme krvnog tlaka - BMI Kategorija:", bmi_cat)) &
    theme(plot.title = element_text(hjust = 0.5))

  qq_combined <- qq_hi + qq_lo + 
    plot_layout(ncol = 2) + 
    plot_annotation(title = paste("Q-Q Plotovi krvnog tlaka - BMI Kategorija:", bmi_cat)) &
    theme(plot.title = element_text(hjust = 0.5))

  combined_plots <- (hist_combined / qq_combined) + 
    plot_layout(ncol = 1) +
    plot_annotation(title = paste("Analiza krvnog tlaka - BMI Kategorija:", bmi_cat)) &
    theme(plot.title = element_text(hjust = 0.5),
          plot.margin = margin(10, 10, 10, 10))

  print(combined_plots)
  cat("\\newpage")
}

```
Nakon crtanja histograma i Q-Q plotova dobivamo dojam da skupine ne ispunjavaju uvjet normalnosti, ali svejedno ćemo provesti Kolmogorov-Smirnovljev test kako bismo tu tvrdnju dodatno provjerili. Također, provest ćemo i Bartlettov test za provjeru homoskedastičnosti, koja je još bitnija pretpostavka ANOVE.

```{r}
# Potrebne biblioteke
library(dplyr)
library(car)  # za Leveneov test

# 1) Test normalnosti po grupama (Kolmogorov-Smirnov)
bmi_categories <- unique(healthDATA.clean$BMICat)

for (bmi_cat in bmi_categories) {
  
  data_subset <- healthDATA.clean %>%
    filter(BMICat == bmi_cat)
  
  cat("==================================================\n")
  cat("BMI Category:", bmi_cat, "\n")
  cat("Broj zapisa u ovoj kategoriji:", nrow(data_subset), "\n")
  
  # Kolmogorov–Smirnov test za ap_hi
  ks_hi <- ks.test(
    data_subset$ap_hi, 
    "pnorm",
    mean = mean(data_subset$ap_hi), 
    sd   = sd(data_subset$ap_hi)
  )
  cat("\n>> Kolmogorov-Smirnov test - ap_hi <<\n")
  cat("  p-value:", ks_hi$p.value, "\n")
  
  # Kolmogorov–Smirnov test za ap_lo
  ks_lo <- ks.test(
    data_subset$ap_lo, 
    "pnorm",
    mean = mean(data_subset$ap_lo), 
    sd   = sd(data_subset$ap_lo)
  )
  cat("\n>> Kolmogorov-Smirnov test - ap_lo <<\n")
  cat("  p-value:", ks_lo$p.value, "\n\n")
}

cat("==================================================\n")
cat("     Test homoskedastičnosti (BartlettTest)\n")
cat("==================================================\n")

# Bartlettov test za sistolički tlak
bartlett_hi <- bartlett.test(ap_hi ~ BMICat, data = healthDATA.clean)
cat("\nBartlett test: ap_hi ~ BMICat\n")
print(bartlett_hi)

# Bartlettov test za dijastolički tlak
bartlett_lo <- bartlett.test(ap_lo ~ BMICat, data = healthDATA.clean)
cat("\nBartlett test: ap_lo ~ BMICat\n")
print(bartlett_lo)


```

Iščitavanjem p-vrijednosti iz testova možemo odbaciti pretpostavke o normalnosti i homoskedastičnosti skupina. Stoga moramo odustati od provedbe ANOVE te se okrećemo njezinoj neparametarskoj alternativi, Kruskal-Wallisovu testu.

```{r}
# Kruskal-Wallis za sistolički tlak
kruskal_hi <- kruskal.test(ap_hi ~ BMICat, data = healthDATA.clean)
cat("----- Kruskal-Wallis Test za sistolički tlak -----\n")
print(kruskal_hi)

# Kruskal-Wallis za dijastolički tlak
kruskal_lo <- kruskal.test(ap_lo ~ BMICat, data = healthDATA.clean)
cat("\n----- Kruskal-Wallis Test za dijastolički tlak -----\n")
print(kruskal_lo)


```
Nakon provedbe Kruskal-Wallisova testa vidimo da niske p-vrijednosti sugeriraju odbacivanje početne hipoteze o jednakosti sredina te prihvaćamo alternativu da se stvarne sredine razlikuju među različitim BMI skupinama.


#Zadatak 4
##Kakav je odnos izmedu BMI-a i krvnog tlaka te možemo li predvidjeti krvni tlak na temelju BMI-a, dobi i učestalosti tjelesne aktivnosti?

Želimo odgovoriti na sljedeće pitanje: "Kakav je odnos izmedu BMI-a i krvnog tlaka te možemo li predvidjeti krvni tlak na temelju BMI-a, dobi i učestalosti tjelesne aktivnosti?"

Sada ćemo metodom najmanjih kvadrata pokušati uspostaviti vezu između BMI-a i krvnog tlaka.
```{r}

fit.ap_hi <- lm(ap_hi ~ poly(BMI,1) , data = filtered_data)

plot(filtered_data$BMI, filtered_data$ap_hi, 
     main = "Odnos sistoličkog krvnog tlaka i BMI-a",
     xlab = "Body Mass Index (BMI)", 
     ylab = "Sistolički krvni tlak (ap_hi)",
     pch = 16, col = rgb(0, 0, 0, 0.5)) 


sorted_index <- order(filtered_data$BMI) 
lines(filtered_data$BMI[sorted_index], 
      fit.ap_hi$fitted.values[sorted_index], 
      col = "red", lwd = 2) 

summary(fit.ap_hi)
```
Iznad možemo vidjeti graf raspršenja između sistoličkog tlaka i BMI-a kao i pravac linearne regresije koji smo izračunali iz podataka. Pokušavali smo linearnu regresiju s polinomima viših stupnjeva, ali su svi stupnjevi bili veoma slični pravcima i nisu poboljšavali vrijednost $R^2$. Zbog toga smo dali prednost najjednostavnijem modelu, a to je naravno pravac. 
Vidimo blagi pozitivan trend, ali se iz p vrijednosti vidi da je značajnost regresora skoro pa zanemariva. Također, $R^2$ vrijednost je 0.0564 ($R^2_{adj}$ je  0.05638) što ukazuje na loš fit modela, no mi ćemo svakako sada nastaviti s analizom reziduala.

```{r}
standardized_residuals <- rstandard(fit.ap_hi)
ks_test <- ks.test(standardized_residuals, "pnorm")
print(ks_test)

require(nortest)
lilliefors_test <- lillie.test(standardized_residuals)
print(lilliefors_test)
```

Reziduali padaju na testu normalnosti (i KS i Lilliefors). Možemo također vidjeti kako se reziduali ponašaju grafički:
```{r res}
plot(fit.ap_hi$residuals,
     main = "Graf reziduala (ap_hi)", 
     ylab = "Reziduali", xlab = "BMI")

hist(fit.ap_hi$residuals, 
     breaks = 20, 
     main = "Histogram Reziduala (ap_hi)", 
     xlab = "Reziduali")

hist(rstandard(fit.ap_hi), 
     breaks = 20, 
     main = "Histogram standardiziranih reziduala (ap_hi)", 
     xlab = "Standardizirani reziduali")

qqnorm(rstandard(fit.ap_hi), 
       main = "Q-Q plot standardiziranih reziduala (ap_hi)")
qqline(rstandard(fit.ap_hi), col = "red", lwd = 2)

plot(fit.ap_hi$fitted.values, fit.ap_hi$residuals, 
     main = "Reziduali u odnosu na fitane vrijednosti (ap_hi)", 
     xlab = "Fitane vrijednosti", ylab = "Reziduali", pch = 16)
abline(h = 0, col = "red", lwd = 2)

```

Q-Q plot nam govori da ova razdioba ima lakše repove od normalne, ali ovo svakako nije normalna distribucija.
Sada možemo zaključiti da je nemoguće predvidjeti sistolički krvni tlak iz BMI-a (iz ovih podataka).


Za dijastolički krvni tlak ponavljamo isti postupak.
```{r}
fit.ap_lo <- lm(ap_lo ~ poly(BMI, 1) , data = filtered_data)
plot(filtered_data$BMI, filtered_data$ap_lo, 
     main = "Odnos dijatoličkog krvnog tlaka i BMI-a",
     xlab = "Body Mass Index (BMI)", 
     ylab = "dijastolički krvni tlak (ap_lo)",
     pch = 16, col = rgb(0, 0, 0, 0.5)) 


sorted_index <- order(filtered_data$BMI) 
lines(filtered_data$BMI[sorted_index], 
      fit.ap_lo$fitted.values[sorted_index], 
      col = "red", lwd = 2) 
summary(fit.ap_lo)
```

Zadržat ćemo model pravca iz istog razloga kao i za sistolički tlak. Vidi se blagi pozitivan trend, ali vidimo (iz p vrijednosti) da regresor ima jako malenu značajnost. Također, $R^2$ vrijednost je sada 0.04008 ($R^2_{adj}$ je  0.04007) što opet ukazuje na loš fit modela, no mi ćemo svakako opet nastaviti s analizom reziduala.
Analiza reziduala
```{r}
standardized_residuals <- rstandard(fit.ap_hi)

ks_test <- ks.test(standardized_residuals, "pnorm")
print(ks_test)

lilliefors_test <- lillie.test(standardized_residuals)
print(lilliefors_test)
```

Reziduali padaju na testu normalnosti (i KS i Lilliefors). Možemo također vidjeti kako se reziduali ponašaju grafički:

```{r}
plot(fit.ap_lo$residuals,
     main = "Graf reziduala (ap_lo)", 
     ylab = "Reziduali", xlab = "BMI")

hist(fit.ap_lo$residuals, 
     breaks = 20, 
     main = "Histogram Reziduala (ap_lo)", 
     xlab = "Reziduali")

hist(rstandard(fit.ap_lo), 
     breaks = 20, 
     main = "Histogram standardiziranih reziduala (ap_lo)", 
     xlab = "Standardizirani reziduali")

qqnorm(rstandard(fit.ap_lo), 
       main = "Q-Q plot standardiziranih reziduala (ap_lo)")
qqline(rstandard(fit.ap_lo), col = "red", lwd = 2)

plot(fit.ap_lo$fitted.values, fit.ap_lo$residuals, 
     main = "Reziduali u odnosu na fitane vrijednosti (ap_lo)", 
     xlab = "Fitane vrijednosti", ylab = "Reziduali", pch = 16)
abline(h = 0, col = "red", lwd = 2)

```
Grafički možemo reći da reziduali imaju teže repove, ali se ne ponašaju baš pravino.
Nemoguće je (na temelju ovih podataka) predvidjeti dijastolički krvni tlak iz BMI-a.






Obratimo sada pažnju na drugi dio problema: "Možemo li predvidjeti krvni tlak na temelju BMI-a, dobi i učestalosti tjelesne aktivnosti?"

Kada radimo na višestrukoj regrešiji želimo da nam regresori budu međusobno "dovoljno" nezavisni, inače ne možemo interpretirati rezultate. Stoga računamo kovarijancu za sve parove od BMI, starosti i tjelesne aktivnosti.
NAPOMENA: S obzirom da je tjelesna aktivnost binarna kategorijska varijabla nije loša ideja staviti ju u model višestruke regresije.

```{r}
cor(cbind(filtered_data$active,filtered_data$BMI,filtered_data$AgeinYr))
```
Iz kovarijanci možemo zaključiti da su varijable "dovoljno" nezavisne. Veću zavisnost vidimo između BMI i starosti, što ima smisla jer kako starimo naša visina se toliko ne mijenja koliko naša masa, pa je normalno da će BMI ovisiti o starosti, no svakako možemo pretpostaviti nezavisnost i zbog toga što je najstarija osoba u uzorku ima $64$ godina, što nije dovoljno staro da krene značajno odumiranje mišićnog tkiva.


```{r}
fit.multi <- lm(ap_hi ~ BMI + active + AgeinYr, filtered_data) #ako maknete regresore koji su manje značajni R^2 pada
#fit.multi = lm(ap_hi ~ AgeinYr + active, filtered_data)
summary(fit.multi)
```
Vidimo da je jedini značajan regresor mjera tjelesne aktivnosti, no s trenutnim odabirom regresora dobivamo najbolju $R^2$ vrijednost tako da smo ih odlučili zadržati.

Nastavimo s analizom reziduala. Prvo testiramo normalnost:

```{r residuali - visestruka regresija}
plot(fit.multi$fitted.values,fit.multi$residuals) 

#KS test na normalnost 
ks.test(rstandard(fit.ap_hi),'pnorm')

require(nortest)
lillie.test(rstandard(fit.ap_hi))

```

```{r}
selected.model = fit.multi
plot(selected.model$fitted.values,selected.model$residuals)
plot(filtered_data$BMI, selected.model$residuals)
plot(filtered_data$age, selected.model$residuals)
```
```{r}
ks.test(rstandard(fit.multi),'pnorm')
require(nortest)
lillie.test(rstandard(fit.multi))
```
```{r}
boxplot(ap_hi~active,data=filtered_data)

boxplot(ap_lo~active,data=filtered_data)

notA <- subset(filtered_data, active == 0)
A <- subset(filtered_data, active == 1)
mean(notA$ap_hi)
mean(A$ap_hi)
mean(notA$ap_lo)
mean(A$ap_lo)
```

Iz grafova gore se ne čini kao da tjelesna aktivnost uopće utječe na krvni tlak.

#Zaključak projekta

Na temelju provedene analize možemo zaključiti da skup podataka o zdravstvenim informacijama nudi važne uvide, ali i pokazuje određene nedostatke koji utječu na kvalitetu interpretacije. Uočena je visoka prisutnost zdravih kategorija kolesterola u svim skupinama, dok starije dobne skupine pokazuju povećan rizik za opasne razine kolesterola. Slično tome, distribucija BMI-ja i krvnog tlaka ukazuje na određene tendencije, ali analize sugeriraju da predikcija krvnog tlaka na temelju BMI-a i dodatnih varijabli ima ograničenu pouzdanost.

Pristranosti, poput zaokruživanja izmjerenih vrijednosti krvnog tlaka, dodatno otežavaju interpretaciju i ukazuju na potrebu za unapređenjem metoda prikupljanja podataka. Također, razlike u krvnom tlaku između pušača i nepušača, kao i između aktivnih i neaktivnih osoba, nisu bile praktično značajne.

Unatoč ograničenjima, analiza je ukazala na smjerove za daljnje istraživanje, osobito u pogledu povezanosti zdravstvenih parametara i načina prikupljanja podataka. Ovi uvidi mogu poslužiti kao osnova za buduća istraživanja i razvoj pouzdanijih prediktivnih modela.