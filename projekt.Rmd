---
title: "[SAP] Projektni zadatak - Analiza podataka zdravstvenog pregleda"
author: "Statistički najizglednije ime"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(results = 'hold')
library(tidyverse)
library(lubridate)
library(nortest)
library(car)
```

#Inicijalni koraci projekta
## Učitavanje podataka

```{r, include=FALSE}
# Učitavanje podataka iz csv datoteke:
healthDATA.modif = read_csv("Health Screening Data.csv")
View(healthDATA.modif)
total = 0
weird = 0
for (p in healthDATA.modif$ap_hi) {
  if (p < 50) {
    weird = weird + 1
  }
  total = total + 1
}
weird / total
```
##Filtriranje podataka

Kao prvi korak analize provodi se filtriranje skupa podataka kako bi izbacili besmislene podatke. Izbacuju se podaci gdje su iznosi tlaka nerealni. Također se izbacuju podaci za tlak gdje je izmjereni maksimalni tlak manji od minimalnog. Izbacujemo BMI podatke koji su veći od najvećeg izmjerenog BMI u povijesti.

```{r}
# Filtriranje besmislenih podataka iz tablice
filtered_data <- healthDATA.modif %>% filter(ap_hi <= 370) %>% filter(ap_lo <= 360) %>% filter(ap_hi >= 40) %>% filter(ap_lo >= 0) %>% filter(ap_hi >= ap_lo) %>% filter(BMI <= 251.1) 

filtered_data <- filtered_data %>%
  mutate(
    cholesterol = as.factor(cholesterol),
    gender = as.factor(gender),
    AgeGroup = as.factor(AgeGroup)
  ) %>% mutate (AgeGroup = fct_relevel(AgeGroup, "20-40", "40-60", ">60"))

summary(filtered_data)
head(filtered_data)
```

```{r}
#Analiza skupa podataka
filtered_data <- filtered_data %>%
  mutate(gender = factor(gender, 
                         levels = c(1, 2), 
                         labels = c("Female", "Male")))

average_weight <- filtered_data %>%
  group_by(gender) %>%
  summarise(avg_weight = mean(weight, na.rm = TRUE))

average_weight

average_height <- filtered_data %>%
  group_by(gender) %>%
  summarise(avg_height = mean(height, na.rm = TRUE))

average_height

str(filtered_data)
head(filtered_data)
```

#Zadatak 1: 
##Kakva je distribucija razina kolesterola među različitim dobnim skupinama i spolovima?

```{r}
# Zadatak 1

distribution <- filtered_data %>%
  group_by(gender, cholesterol) %>%
  summarise(count = n(),
            percentage = n() / nrow(filtered_data) * 100)

distribution

ggplot(filtered_data, aes(x = cholesterol, fill = gender)) +
  geom_bar(position = "dodge") +
  facet_wrap(~ AgeGroup) +
  labs(title = "Distribucija kolesterola prema spolu i dobnoj skupini",
       x = "Kategorije kolesterola",
       y = "Broj uzoraka") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink"))

```
Sljedeći grafovi prikazuju raspodjelu postotka pripadnosti trima kategorijama kolesterola (zdrav, rizičan i opasan). Svaka skupina kolesterola (označena bojama) predstavlja određeni zdravstveni status:

    Zdrav (1) – prikazan zelenkastom bojom,
    Rizičan (2) – prikazan žutom bojom,
    Opasan (3) – prikazan ljubičastom bojom.

Prvi graf prikazuje raspodjelu unutar tri dobne skupine: 20-40 godina, 40-60 godina i iznad 60 godina.

```{r}
cholesterol_age <- filtered_data %>%
  group_by(AgeGroup, cholesterol) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(AgeGroup) %>%
  mutate(percentage = count / sum(count) * 100)

ggplot(cholesterol_age, aes(x = cholesterol, y = percentage, fill = cholesterol)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ AgeGroup) +
  labs(title = "Postotak kolesterola unutar dobnih skupina",
       x = "Kategorija kolesterola",
       y = "Postotak") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")
```
Zaključci sa grafa:
  - Zdrava kategorija dominira u svakoj dobnoj skupini.
  - Dobna skupina 20-40 ima najzdravije razine kolesterola, sa najmanjom zastupljenosti rizične ili opasne kategorije.
  - Dobna skupina iznad 60 godina, iako još uvijek teži zdravoj kategoriji kolesterola, ima češću zastupljenost rizične ili opasne kategorije od ostalih grupa. Također je jedina grupa gdje je opasna kategorija češća od rizične.
  
Sljedeći graf prikazuje raspodjelu unutar spolova.
```{r}
cholesterol_gender <- filtered_data %>%
  group_by(gender, cholesterol) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(gender) %>%
  mutate(percentage = count / sum(count) * 100)

ggplot(cholesterol_gender, aes(x = cholesterol, y = percentage, fill = cholesterol)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ gender) +
  labs(title = "Postotak kolesterola unutar spolova",
       x = "Kategorija kolesterola",
       y = "Postotak") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")
```
Zaključci sa grafa:
  - Zdrava kategorija dominira u svakom spolu.
  - Ne pokazuju se značajne razlike u postotnoj distribuciji kategorija kolesterola.

##Prikaz dodatnih distribucija

Sljedeći grafovi prikazuju distribucija BMI-ja.
Filtrirani grafovi služe kako bi lakše vidjeli tendenciju distribucije, fokusiranjem na češće iznose.

Prvi grafovi prikazuju distribuciju BMI-ja po dobnim skupinama.

```{r}

BMI_filtered_data <- filtered_data %>% filter(BMI <= 60)

ggplot(filtered_data, aes(x = BMI, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija BMI-ja prema dobnoj skupini",
       x = "BMI",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")

ggplot(BMI_filtered_data, aes(x = BMI, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Filtrirana Distribucija BMI-ja prema dobnoj skupini",
       x = "BMI",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")
```
Zaključak
  - BMI teži iznosima između 20 i 30. Postoji značajna količina podataka koja se nalazi između 30 te opada prema 40. Ostali iznosi nisu bitno reprezentirani.

Idući graf prikazuje distribuciju BMI-ja unutar spolova:
```{r}
ggplot(filtered_data, aes(x = BMI, color = gender, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija BMI-ja prema spolu",
       x = "BMI",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink")) +
  scale_color_manual(values = c("blue", "pink"))

ggplot(BMI_filtered_data, aes(x = BMI, color = gender, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(title = "Filtrirana distribucija BMI-ja prema spolu",
       x = "BMI",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink")) +
  scale_color_manual(values = c("blue", "pink"))
```
Zaključak
  - BMI teži iznosima između 20 i 30. Postoji značajna količina podataka koja se nalazi između 30 te opada prema 40. Ostali iznosi nisu bitno reprezentirani.

Sljedeći grafovi prikazuju distribucije iznosa sistoličkog i dijastoličkog krvnog tlaka..
Filtrirani grafovi služe kako bi lakše vidjeli tendenciju distribucije, fokusiranjem na češće iznose.

Prvi grafovi prikazuju distribucije krvnog tlaka prema dobnoj skupini:

```{r}
ap_filtered_data <- filtered_data %>% filter(ap_hi <= 190) %>% filter(ap_lo <= 130) %>% filter(ap_hi >= 80) %>% filter(ap_lo >= 50)

ggplot(filtered_data, aes(x = ap_hi, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija sistoličkog krvnog tlaka prema dobnoj skupini",
       x = "Sistolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")

ggplot(filtered_data, aes(x = ap_lo, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija dijastoličkog krvnog tlaka prema dobnoj skupini",
       x = "Dijastolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")
```


```{r}
ggplot(ap_filtered_data, aes(x = ap_hi, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Filtrirana distribucija sistoličkog krvnog tlaka prema dobnoj skupini",
       x = "Sistolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")

ggplot(ap_filtered_data, aes(x = ap_lo, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Filtrirana distribucija dijastoličkog krvnog tlaka prema dobnoj skupini",
       x = "Dijastolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")
```
Zaključak
  - Krvni tlak ima višemodalnu distribuciju. 
  - Najčešći iznos krvnog tlaka je 120/80.

Prema spolu:
```{r}
ggplot(filtered_data, aes(x = ap_hi, color = gender, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija sistoličkog krvnog tlaka prema spolu",
       x = "Sistolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink")) +
  scale_color_manual(values = c("blue", "pink"))

ggplot(filtered_data, aes(x = ap_lo, color = gender, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija dijastoličkog krvnog tlaka prema spolu",
       x = "Dijastolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink")) +
  scale_color_manual(values = c("blue", "pink"))
```

```{r}
ggplot(ap_filtered_data, aes(x = ap_hi, color = gender, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(title = "Filtrirana distribucija sistoličkog krvnog tlaka prema spolu",
       x = "Sistolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink")) +
  scale_color_manual(values = c("blue", "pink"))

ggplot(ap_filtered_data, aes(x = ap_lo, color = gender, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(title = "Filtrirana distribucija dijastoličkog krvnog tlaka prema spolu",
       x = "Dijastolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "pink")) +
  scale_color_manual(values = c("blue", "pink"))
```
Zaključak
  - Krvni tlak ima višemodalnu distribuciju. 
  - Najčešći iznos krvnog tlaka je 120/80.

Analizom distribucije krvnog tlaka primijetili smo da se podaci raspodjeljuju višemodalno, što intuitivno nije logično. Na primjer, zašto bi tlak od 80 bio učestaliji od tlaka 85, dok je tlak od 90 također učestaliji od 85? Objašnjenje leži u tendenciji liječnika da zaokružuju vrijednosti krvnog tlaka na brojeve koji završavaju nulom.

Kako je navedeno u dokumentu Svjetske zdravstvene organizacije (WHO) iz travnja 2020., "tehničke pogreške uzrokovane opažačem uključuju sustavne pogreške povezane s ... i suboptimalno bilježenje izmjerenih vrijednosti krvnog tlaka. Primjer je 'preferencija završnog broja', pri čemu opažač zaokružuje izmjerene vrijednosti na preferirani broj, obično nulu." (Izvor: WHO technical specifications for automated non-invasive blood pressure measuring devices with cuff)

Smatramo da ovaj fenomen značajno utječe na statističke analize. Kako bismo bolje reprezentirali podatke i smanjili utjecaj ove pristranosti, u analizu smo uključili dodavanje uniformnog šuma.
 
```{r}
set.seed(906) 

original_filtered_data <- filtered_data

filtered_data <- filtered_data %>%
  mutate(
    ap_hi = ap_hi + runif(n(), min = -5 , max = 5),
    ap_lo = ap_lo + runif(n(), min = -5 , max = 5)
  )

ap_filtered_data <- filtered_data %>% filter(ap_hi <= 190) %>% filter(ap_lo <= 130) %>% filter(ap_hi >= 80) %>% filter(ap_lo >= 50)

ggplot(ap_filtered_data, aes(x = ap_hi, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija sistoličkog krvnog tlaka sa dodanim šumom prema dobnoj skupini",
       x = "Sistolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")

ggplot(ap_filtered_data, aes(x = ap_lo, color = AgeGroup, fill = AgeGroup)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribucija dijastoličkog sa dodanim šumom krvnog tlaka prema dobnoj skupini",
       x = "Dijastolički krvni tlak",
       y = "Gustoća") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2")
```

#Zadatak 2

---
title: "SAP projekt - Analiza podataka zdravstvenog pregleda"
subtitle: "Ovisnost krvnog tlaka o pušenju" 
output: html_notebook
---

Testiramo postoji li statistički značajna razlika u prosječnim krvnim tlakovima kod pušača i kod nepušača. Pušenje je kategorijska varijabla (razlikujemo pušače i nepušače, a nema podataka o tome koliko često tko puši).

```{r}
library(nortest)
library(dplyr)
data = read.csv("Health Screening Data.csv")
names(data)
summary(data)
```
Među podacima o krvnom tlaku ima besmislenih vrijednosti, poput negativnih brojeva ili jako niskih tlakova koji nisu fiziološki mogući.
```{r}
data$ap_hi[data$ap_hi < 30]
```


Zato proglašavamo neispravnim i eliminiramo sve uzorke u kojima je zabilježen gornji (sistolički) tlak ispod 30 mmHg.

```{r}
ok = which(data$ap_hi >= 30)
data2 = filtered_data
summary(data2$ap_hi)
```
Nakon filtriranja tlakove pušača i nepušača možemo prvo usporediti grafički pomoću box plotova. U uzorku preostaje oko 6100 pušača i 63000 nepušača nakon eliminacije besmislenih vrijednosti, što znači da imamo dovoljno podataka da kasnije u testiranju možemo koristiti centralni granični teorem. Vidimo da plotovi izgledaju dosta slično. I dalje postoji dosta outliera, pogotovo s visokim tlakom, ali nema ih smisla odbaciti kao pogrešna mjerenja jer je najveći tlak 240, što je sasvim moguća vrijednost.

```{r}
pusaci = data2[data2["smoke"]==1,]
nepusaci = data2[data2["smoke"]==0,]
nrow(pusaci)
nrow(nepusaci)

boxplot(nepusaci$ap_hi,
        main='box-plot tlaka nepušača',
        ylab='sistolički tlak/mmHg')
boxplot(pusaci$ap_hi,
        main='box-plot tlaka pušača',
        ylab='sistolički tlak/mmHg')

```
Prikaz mjerenja sistoličkog tlaka na histogramu pokazuje da su vrijednosti često zaokruživane na najbliži "okrugli" broj. To može predstavljati problem u daljnem radu. Stoga ćemo na tlakove dodati aditivni uniformni šum s rasponom od -5 do 5. Odabrali smo uniformni šum jer nemamo nikakvu informaciju o originalnoj vrijednosti prije zaokruživanja osim da je morala biti iz navedenog raspona jer bi inače bila zaokružena na drugi broj. Nemamo razlog smatrati neku od vrijednosti iz tog raspona vjerojatnijom od drugih. 

```{r}
hist(original_filtered_data$ap_hi, breaks = seq(from=min(original_filtered_data$ap_hi)-1, to=max(original_filtered_data$ap_hi)+1, by=1), main="mjerenja tlaka",
xlab="sistolički tlak [mmHg]",
col="darkmagenta")
set.seed(906)

hist(filtered_data$ap_hi, breaks = seq(from=min(filtered_data$ap_hi)-1, to=max(filtered_data$ap_hi)+1, by=1), main="mjerenja tlaka nakon uvođenja šuma",
xlab="sistolički tlak [mmHg]",
col="pink")
```

Najprije provjeravama jesu li podaci iz normalne razdiobe. Kako ne znamo koju konkretnu normalnu razdiobu očekujemo, koristimo Lillieforsovu inačicu Kolmogorov-Smirnovljevog testa. Posebno testiramo tlakove pušača i tlakove nepušača. Također radimo Q-Q plotove za vizualnu usporedbu kvantila s kvantilima normalne razdiobe.
```{r}
pusaci = data2[data2["smoke"]==1,]
nepusaci = data2[data2["smoke"]==0,]

lillie.test(pusaci$ap_hi)
lillie.test(nepusaci$ap_hi)
qqnorm(pusaci$ap_hi, main = "Q-Q plot za tlakove pušača")
qqline(pusaci$ap_hi, col="blue")

qqnorm(nepusaci$ap_hi, main = "Q-Q plot za tlakove nepušača")
qqline(nepusaci$ap_hi, col="red")

```
Test odbacuje nul-hipotezu (da su podaci slučajan uzorak iz normalne razdiobe) za obje grupe na razini značajnosti od 1%. Na Q-Q plotovima vidimo da distribucija podataka relativno dobro prati normalnu za vrijednosti oko prosjeka i manje, ali ima vrlo teški rep prema većim vrijednostima. To je u skladu s prisutnošću mnogo outliera vidljivih u tom području na box plotu.

Treba provjeriti jesu li varijance grupa jednake. Provodimo F-test za jednakost varijanci sitoličkih tlakova nepušača i pušača. Dobivamo vrlo malu p-vrijednost, pa odbacujemo nul-hipotezu. Procijenjeni omjer varijanci je oko 0.9, dakle pušači imaju veću varijancu u sistoličkom tlaku nego nepušači. Poznato je da pušenje uzrokuje kratkotrajni porast krvnog tlaka. Moguće je tlakovi pušača više variraju jer su nekim pušačima tlakovi izmjereni ubrzo nakon pušenja, a nekima nakon nekoliko sati bez cigareta. U svakom slučaju, ne možemo pretpostaviti jednakost varijanci u daljnjim testovima.

```{r}
var.test(nepusaci$ap_hi, pusaci$ap_hi)
```

Testiramo hipotezu o jednakosti prosječnih krvnih tlakova u obje grupe koristeći T test za neuparene podatke uz nepoznate i nejednake varijance na razini značajnosti od 5%. Ne uzimamo pretpostavku da su varijance jednake zbog rezultata prethodnog testa. 

```{r}
t.test(data2[data2["smoke"]==0,]$ap_hi, data2[data2["smoke"]==1,]$ap_hi, alternative = "two.sided", mu = 0, paired = FALSE, var.equal = FALSE, conf.level = 0.95)
```
Dobivena P vrijednost je vrlo mala pa možemo odbaciti hipotezu o jednakosti srednjih vrijednosti sistoličkih tlakova na razini značajnosti od 5%. Test pokazuje statistički značajnu razliku, no procijenjena razlika sredina je mala u odnosu na 30 mmHg koliko otprilike iznosi širina intervala normalnih tlakova pa je značaj te razlike u praksi upitan.

#Zadatak 3


```{r}

# Učitavanje podataka iz csv datoteke:
healthDATA.modif = read.csv("Health Screening Data.csv")
View(healthDATA.modif)

```

Podjela na dvije tablice: za aktivne i neaktivne
```{r}

# Funkcija za uklanjanje outliera
remove_outliers <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower <- Q1 - 1.5 * IQR
  upper <- Q3 + 1.5 * IQR
  x[x >= lower & x <= upper]
}

# Filtriranje podataka za ap_lo i ap_hi:
healthDATA.filtered <- healthDATA.modif %>%
  group_by(BMICat) %>%
  filter(ap_lo >= quantile(ap_lo, 0.25) - 1.5 * IQR(ap_lo) & 
           ap_lo <= quantile(ap_lo, 0.75) + 1.5 * IQR(ap_lo)) %>%
  filter(ap_hi >= quantile(ap_hi, 0.25) - 1.5 * IQR(ap_hi) & 
           ap_hi <= quantile(ap_hi, 0.75) + 1.5 * IQR(ap_hi))


# Generiranje box plotova bez outliera:
boxplot(ap_lo ~ BMICat, 
        data = healthDATA.filtered,
        main = "Box Plot za ap_lo prema BMI kategorijama (bez outliera u podacima)",
        xlab = "BMI Kategorije",
        ylab = "ap_lo",
        col = "lightblue")

boxplot(ap_hi ~ BMICat, 
        data = healthDATA.filtered,
        main = "Box Plot za ap_hi prema BMI kategorijama (bez outliera u podacima)",
        xlab = "BMI Kategorije",
        ylab = "ap_hi",
        col = "lightgreen")

```


Izračun prosječnih vrijedosti po tablici
```{r}

# Filtriranje podataka za kategoriju "Overweight":
overweight_data <- healthDATA.modif %>%
  filter(BMICat == "Over Weight")

# Histogram distribucije ap_hi za Overweight:
ggplot(overweight_data, aes(x = ap_hi)) +
  geom_histogram(binwidth = 10, fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Distribucija višeg tlaka (ap_hi) za Overweight",
       x = "Visoki tlak (ap_hi)",
       y = "Frekvencija") +
  theme_minimal()

# Density graf distribucije ap_hi za Overweight:
ggplot(overweight_data, aes(x = ap_hi)) +
  geom_density(fill = "lightgreen", alpha = 0.7) +
  labs(title = "Gustoća distribucije višeg tlaka (ap_hi) za Overweight",
       x = "Visoki tlak (ap_hi)",
       y = "Gustoća") +
  theme_minimal()



```

```{r}

# Filtriranje podataka za kategoriju "Overweight":
overweight_data <- healthDATA.modif %>%
  filter(BMICat == "Over Weight")

# Izračun kvartila za ap_hi:
quartiles <- quantile(overweight_data$ap_hi, probs = c(0.25, 0.5, 0.75, 1.0), na.rm = TRUE)

# Ispis rezultata:
print(quartiles)

```



```{r}

# Funkcija za uklanjanje outliera:
remove_outliers <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower <- Q1 - 1.5 * IQR
  upper <- Q3 + 1.5 * IQR
  return(x[x >= lower & x <= upper])
}

# Filtriranje podataka za kategoriju "Overweight":
overweight_data <- healthDATA.modif %>%
  filter(BMICat == "Over Weight")

# Uklanjanje outliera iz ap_hi:
filtered_ap_hi <- remove_outliers(overweight_data$ap_hi)

# Tablica frekvencija za ap_hi bez outliera:
freq_table <- as.data.frame(table(filtered_ap_hi))

# Dodavanje naziva stupaca:
colnames(freq_table) <- c("Vrijednost_ap_hi", "Frekvencija")

# Ispis tablice frekvencija:
print(freq_table)

```

```{r}

# Izračun srednje vrijednosti za sve podatke (sve BMI grupe zajedno) za ap_hi i ap_lo:
srednja_sve <- healthDATA.modif %>%
  summarise(Srednja_ap_hi = mean(ap_hi, na.rm = TRUE),
            Srednja_ap_lo = mean(ap_lo, na.rm = TRUE))

# Izračun srednje vrijednosti za svaku BMI grupu odvojeno za ap_hi i ap_lo:
srednja_po_grupama <- healthDATA.modif %>%
  group_by(BMICat) %>%
  summarise(Srednja_ap_hi = mean(ap_hi, na.rm = TRUE),
            Srednja_ap_lo = mean(ap_lo, na.rm = TRUE))

# Ispis rezultata:
cat("Srednje vrijednosti za sve BMI grupe zajedno:\n")
print(srednja_sve)

cat("\nSrednje vrijednosti za svaku BMI grupu odvojeno:\n")
print(srednja_po_grupama)



```

```{r}


# Provjera veličine svake BMI grupe
velicine_grupa <- healthDATA.modif %>%
  group_by(BMICat) %>%
  summarise(Velicina = n())

cat("Veličine BMI grupa:\n")
print(velicine_grupa)

# Kolmogorov-Smirnov test za normalnost za svaku grupu i za ap_hi i ap_lo
ks_test_rezultati <- healthDATA.modif %>%
  group_by(BMICat) %>%
  summarise(
    KS_ap_hi_stat = ks.test(ap_hi, "pnorm", mean(ap_hi, na.rm = TRUE), sd(ap_hi, na.rm = TRUE))$statistic,
    KS_ap_hi_pval = ks.test(ap_hi, "pnorm", mean(ap_hi, na.rm = TRUE), sd(ap_hi, na.rm = TRUE))$p.value,
    KS_ap_lo_stat = ks.test(ap_lo, "pnorm", mean(ap_lo, na.rm = TRUE), sd(ap_lo, na.rm = TRUE))$statistic,
    KS_ap_lo_pval = ks.test(ap_lo, "pnorm", mean(ap_lo, na.rm = TRUE), sd(ap_lo, na.rm = TRUE))$p.value
  )

cat("\nKolmogorov-Smirnov test rezultati:\n")
print(ks_test_rezultati)

```


```{r}


# Funkcija za uklanjanje outliera:
remove_outliers <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower <- Q1 - 1.5 * IQR
  upper <- Q3 + 1.5 * IQR
  return(ifelse(x >= lower & x <= upper, x, NA))
}

# Uklanjanje outliera za ap_hi i ap_lo:
zd3_filtered_data <- healthDATA.modif %>%
  group_by(BMICat) %>%
  mutate(ap_hi_filtered = remove_outliers(ap_hi),
         ap_lo_filtered = remove_outliers(ap_lo)) %>%
  ungroup()

# Priprema podataka za grafove:
ap_hi_data <- zd3_filtered_data %>%
  select(BMICat, ap_hi_filtered) %>%
  rename(Value = ap_hi_filtered) %>%
  mutate(Variable = "ap_hi")

ap_lo_data <- zd3_filtered_data %>%
  select(BMICat, ap_lo_filtered) %>%
  rename(Value = ap_lo_filtered) %>%
  mutate(Variable = "ap_lo")

# Kombiniranje podataka:
plot_data <- bind_rows(ap_hi_data, ap_lo_data)

# Kreiranje histogram grafova s facet_wrap:
ggplot(plot_data, aes(x = Value, fill = BMICat)) +
  geom_histogram(binwidth = 6, color = "black", alpha = 0.7, position = "dodge") +
  facet_wrap(~ Variable + BMICat, scales = "free", ncol = 2) +
  labs(title = "Histogrami ap_hi i ap_lo prema BMI kategorijama (bez outliera)",
       x = "Vrijednost",
       y = "Frekvencija") +
  theme_minimal() +
  theme(legend.position = "bottom")


```


```{r}

# Funkcija za zaokruživanje na najbliži višekratnik 5:
round_to_nearest_5 <- function(x) {
  round(x / 10) * 10
}

# Funkcija za uklanjanje outliera:
remove_outliers <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower <- Q1 - 1.5 * IQR
  upper <- Q3 + 1.5 * IQR
  return(ifelse(x >= lower & x <= upper, x, NA))
}

# Uklanjanje outliera i zaokruživanje:
zd3_filtered_data <- healthDATA.modif %>%
  group_by(BMICat) %>%
  mutate(
    ap_hi = remove_outliers(ap_hi), # Ukloni outliere za ap_hi
    ap_lo = remove_outliers(ap_lo), # Ukloni outliere za ap_lo
    ap_hi = round_to_nearest_5(ap_hi), # Zaokruži na 5
    ap_lo = round_to_nearest_5(ap_lo)  # Zaokruži na 5
  ) %>%
  ungroup()

# Histogrami za ap_hi:
hist_ap_hi <- ggplot(zd3_filtered_data, aes(x = ap_hi)) +
  geom_histogram(binwidth = 5, color = "black", fill = "lightblue", alpha = 0.7) +
  facet_wrap(~ BMICat, scales = "free_y", ncol = 2) +
  labs(title = "Histograms for ap_hi (Rounded, Outliers Removed)",
       x = "ap_hi (Rounded to 5)",
       y = "Frequency") +
  theme_minimal()

# Histogrami za ap_lo:
hist_ap_lo <- ggplot(zd3_filtered_data, aes(x = ap_lo)) +
  geom_histogram(binwidth = 5, color = "black", fill = "lightgreen", alpha = 0.7) +
  facet_wrap(~ BMICat, scales = "free_y", ncol = 2) +
  labs(title = "Histograms for ap_lo (Rounded, Outliers Removed)",
       x = "ap_lo (Rounded to 5)",
       y = "Frequency") +
  theme_minimal()

# Q-Q grafovi za ap_hi:
qq_ap_hi <- ggplot(zd3_filtered_data, aes(sample = ap_hi)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ BMICat, scales = "free", ncol = 2) +
  labs(title = "Q-Q Plots for ap_hi (Rounded, Outliers Removed)",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_minimal()

# Q-Q grafovi za ap_lo:
qq_ap_lo <- ggplot(zd3_filtered_data, aes(sample = ap_lo)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ BMICat, scales = "free", ncol = 2) +
  labs(title = "Q-Q Plots for ap_lo (Rounded, Outliers Removed)",
       x = "Theoretical Quantiles",
       y = "Sample Quantiles") +
  theme_minimal()

# Prikaz svih grafova:
print(hist_ap_hi)
print(hist_ap_lo)
print(qq_ap_hi)
print(qq_ap_lo)





```


```{r}

# Funkcija za zaokruživanje na najbliži višekratnik 10:
round_to_nearest_10 <- function(x) {
  round(x / 10) * 10
}

# Funkcija za uklanjanje outliera:
remove_outliers <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower <- Q1 - 1.5 * IQR
  upper <- Q3 + 1.5 * IQR
  return(ifelse(x >= lower & x <= upper, x, NA))
}

# Uklanjanje outliera i zaokruživanje na 10:
zd3_filtered_data <- healthDATA.modif %>%
  group_by(BMICat) %>%
  mutate(
    ap_hi = remove_outliers(ap_hi), # Ukloni outliere za ap_hi
    ap_lo = remove_outliers(ap_lo), # Ukloni outliere za ap_lo
    ap_hi = round_to_nearest_10(ap_hi), # Zaokruži na 10
    ap_lo = round_to_nearest_10(ap_lo)  # Zaokruži na 10
  ) %>%
  ungroup()

# Provjera normalnosti za diskretne vrijednosti:
ks_results_rounded_10 <- zd3_filtered_data %>%
  group_by(BMICat) %>%
  summarise(
    KS_ap_hi_stat = ks.test(ap_hi, "pnorm", mean(ap_hi, na.rm = TRUE), sd(ap_hi, na.rm = TRUE))$statistic,
    KS_ap_hi_pval = ks.test(ap_hi, "pnorm", mean(ap_hi, na.rm = TRUE), sd(ap_hi, na.rm = TRUE))$p.value,
    KS_ap_lo_stat = ks.test(ap_lo, "pnorm", mean(ap_lo, na.rm = TRUE), sd(ap_lo, na.rm = TRUE))$statistic,
    KS_ap_lo_pval = ks.test(ap_lo, "pnorm", mean(ap_lo, na.rm = TRUE), sd(ap_lo, na.rm = TRUE))$p.value
  )

# Histogrami za ap_hi i ap_lo:
hist_ap_hi_10 <- ggplot(zd3_filtered_data, aes(x = ap_hi, fill = BMICat)) +
  geom_histogram(binwidth = 10, color = "black", alpha = 0.7, position = "dodge") +
  labs(title = "Histogram za ap_hi (zaokruženo na 10, bez outliera)",
       x = "ap_hi (zaokruženo na 10)",
       y = "Frekvencija") +
  theme_minimal()

hist_ap_lo_10 <- ggplot(zd3_filtered_data, aes(x = ap_lo, fill = BMICat)) +
  geom_histogram(binwidth = 10, color = "black", alpha = 0.7, position = "dodge") +
  labs(title = "Histogram za ap_lo (zaokruženo na 10, bez outliera)",
       x = "ap_lo (zaokruženo na 10)",
       y = "Frekvencija") +
  theme_minimal()

# Prikaz rezultata Kolmogorov-Smirnovog testa:
cat("\nKolmogorov-Smirnov test za normalnost (zaokružene varijable na 10, bez outliera):\n")
print(ks_results_rounded_10)

# Prikaz histogram grafova:
print(hist_ap_hi_10)
print(hist_ap_lo_10)


```

```{r}

# Leveneov test za ap_hi:
levene_ap_hi <- leveneTest(ap_hi ~ BMICat, data = zd3_filtered_data, na.action = na.exclude)

# Leveneov test za ap_lo:
levene_ap_lo <- leveneTest(ap_lo ~ BMICat, data = zd3_filtered_data, na.action = na.exclude)

# Prikaz rezultata:
cat("Rezultati Leveneovog testa za ap_hi:\n")
print(levene_ap_hi)

cat("\nRezultati Leveneovog testa za ap_lo:\n")
print(levene_ap_lo)

```

#Zadatak 4



Sada metodom najmanjih kvadrata pokušavamo uspostaviti vezu između BMI-a i krvnog tlaka.
Probali smo fiksirati nezavisne varijable

Vidimo blagi pozitivan trend, ali koncentracija podataka oko vrijednosti krvnih tlakova djeljivih s 10 podiže sumnju na greške pri mjerenju. Također $R^2$ vrijednost je 0.0576 što je jako malo i povećanje stupnja polinoma ne mijenja značajno tu vrijednosti niti mijenja oblik modela, odnosno on uvijek izgleda kao ili slično pravcu.
Analiza reziduala:
